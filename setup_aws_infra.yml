# this playbook runs the python script that sets up aws infra
---
- hosts: localhost
  gather_facts: no
  tasks:
    - name: set up AWS environment variable
      set_fact:
        Creds:
          AWS_ACCESS_KEY_ID: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            34613034623732303433353631646135393863353664613163656230313931303663343330383339
            3639646431316532626630626362663631343539643662390a366434613637636238316565346234
            33643436363035363462303234383636643333313534626166323830633436356433313032386635
            3331383564323463660a376430636636626362306261353565393262373035363538346233663333
            36343133616530326664303334336231633565373337326535316531323261323738
          AWS_SECRET_ACCESS_KEY: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            35383664383130333666613930643965353237323362343262653438363539303462363962616364
            6136303432616636656565623133616563663131643630370a663566613163376438636636366261
            34646363666666383235666531396264306364336335356435393063386635306362666466376532
            6139326132626333330a636137636339333266336364356362396530393835633865323437393966
            34376235636335633362363433653732353938656339306463333838643765393634306236326638
            3334363834613165383030356433643164393137353663643232
          AWS_DEFAULT_REGION: "ap-southeast-2"

    - name: run python script to setup aws infra
      command: python /home/ec2-user/Ansible/main.py t2.micro sydney ami-03ed5bd63ba378bd8
      register: infra_setup
      environment:
        AWS_DEFAULT_REGION: "{{ Creds['AWS_DEFAULT_REGION'] }}"
        AWS_ACCESS_KEY_ID: "{{ Creds['AWS_ACCESS_KEY_ID'] }}"
        AWS_SECRET_ACCESS_KEY: "{{ Creds['AWS_SECRET_ACCESS_KEY'] }}"
      become: yes
